<!DOCTYPE html>
<html lang="en">
    <head>
        <title></title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <script type="text/javascript">
            /* 
              basic tag setup for the demo
              will be handled via Tealium deployment of liveperson code or direct on page deployment
              purely for demo
             */
            window.lpTag = window.lpTag || {};
            lpTag.section = ["pws", "english", "cmb","uk"];
                       
        </script>
        <script>

            window.lpTag=window.lpTag||{};window.lpTag.autoStart = false;
            if(typeof window.lpTag._tagCount==='undefined'){window.lpTag={site:'90233546'||'',section:lpTag.section||'',autoStart:lpTag.autoStart===false?false:true,ovr:lpTag.ovr||{},_v:'1.6.0',_tagCount:1,protocol:'https:',events:{bind:function(app,ev,fn){lpTag.defer(function(){lpTag.events.bind(app,ev,fn);},0);},trigger:function(app,ev,json){lpTag.defer(function(){lpTag.events.trigger(app,ev,json);},1);}},defer:function(fn,fnType){if(fnType==0){this._defB=this._defB||[];this._defB.push(fn);}else if(fnType==1){this._defT=this._defT||[];this._defT.push(fn);}else{this._defL=this._defL||[];this._defL.push(fn);}},load:function(src,chr,id){var t=this;setTimeout(function(){t._load(src,chr,id);},0);},_load:function(src,chr,id){var url=src;if(!src){url=this.protocol+'//'+((this.ovr&&this.ovr.domain)?this.ovr.domain:'lptag.liveperson.net')+'/tag/tag.js?site='+this.site;}var s=document.createElement('script');s.setAttribute('charset',chr?chr:'UTF-8');if(id){s.setAttribute('id',id);}s.setAttribute('src',url);document.getElementsByTagName('head').item(0).appendChild(s);},init:function(){this._timing=this._timing||{};this._timing.start=(new Date()).getTime();var that=this;if(window.attachEvent){window.attachEvent('onload',function(){that._domReady('domReady');});}else{window.addEventListener('DOMContentLoaded',function(){that._domReady('contReady');},false);window.addEventListener('load',function(){that._domReady('domReady');},false);}if(typeof(window._lptStop)=='undefined'){this.load();}},start:function(){this.autoStart=true;},_domReady:function(n){if(!this.isDom){this.isDom=true;this.events.trigger('LPT','DOM_READY',{t:n});}this._timing[n]=(new Date()).getTime();},vars:lpTag.vars||[],dbs:lpTag.dbs||[],ctn:lpTag.ctn||[],sdes:lpTag.sdes||[],ev:lpTag.ev||[]};lpTag.init();}else{window.lpTag._tagCount+=1;}
            window.lpTag._delayLoad=function(){setTimeout(function(){window.lpTag.start()},1)},window.attachEvent?window.attachEvent("onload",function(){window.lpTag._delayLoad()}):(window.addEventListener("load",function(){window.lpTag._delayLoad()},!1),window.addEventListener("load",function(){window.lpTag._delayLoad()},!1));

        </script>
        <link rel="stylesheet" type="text/css" href="https://netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
        <style type="text/css">
          .container { margin-top: 20px; } 
          #slideout { background: #fff; box-shadow: 0 0 5px rgba(0,0,0,.3); color: #333; position: absolute; top: 100px; right: -520px;
          width: 500px; -webkit-transition-duration: 0.3s; -moz-transition-duration: 0.3s; -o-transition-duration: 0.3s; transition-duration:
          0.3s; } 
          
          #slideout form { display: block; padding: 20px; } 
          
          #slideout textarea { display:block; height: 100px; margin-bottom:
          6px; width: 250px; } 
          
          #slideout.on { right: 0; }

          .vertical-text {
            transform: rotate(-90deg);
            transform-origin: left top 0;
            display: inline-block;
          }

          .need-help {
            position: relative;
            right: 50px;
            top: 100px;
          }

          .lp-va-panel-button {

          }

          .hide-lp-button {
            display: none;
          }
          

        </style>
    </head>
    <body>
      <div class="container">
        <div id="slideout">
          <p class="btn btn-primary need-help vertical-text" id="need-help">Need Help?</button>  
          <form>
            <h4 class="display1">FAQ converstion goes here...</h4>
           
            <div class="faq-lines ">
                <ul class="list-group">
                    <li class="list-group-item faq-chat-line"><b>Customer:</b> Hello</li>
                    <li class="list-group-item faq-chat-line"><b>Virtual Assistant:</b> How can  I help you?</li>
                    <li class="list-group-item faq-chat-line"><b>Customer:</b> I cannot login</li>
                    <li class="list-group-item faq-chat-line"><b>Virtual Assistant:</b> ok I can escalate this to a human please click the chat button below to transfer</li>
                </ul>
             
            </div>
            <!-- <HR>
              <p>debug tools:</p>
              <p> 
              <button type="button" onclick="checkButtonState()" class="btn btn-info">Click me to check the button state</button> </p>
            <HR> -->
            <p id="button-container">
              <a id="lp-va-panel-button-online" href="#" class="btn btn-success lp-va-panel-button hide-lp-button" onclick="triggerChatButtonClick();">Click to chat</a>
              <a id="lp-va-panel-button-offline" href="#" class="btn btn-warning lp-va-panel-button hide-lp-button">All Agents are OFFLINE/BUSY</a>
            </p>
          </form>
        </div>

      </div>
      <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
      <script>

        // some POC vars to contain the unique engagement id of the button embedded within the panel
        // you will need this either hard coded into the panel code itself or stored somewhere easily updateable
        // the engagement id of the embedded button within the VA panel will be different on different LivePErson environments - CLONE/PROD
        /* 
        LP const for easier configuration and updating of this POC code.
        recommend you take a similar approach for your implementation
        */
        var lpButtonEngagementId;
        var lpButtonState;
        var LP_VA_PANEL_HIDDEN_EMBEDDED_BUTTON_DIV_CONTAINER_ID = "lpButtonDiv-va-panel"; // This will be the unique div id for the embedded panel button within the DOM
        var LP_VISIBLE_ONLINE_BUTTON_CLASS_NAME_LIST = "btn btn-success lp-va-panel-button";
        var LP_VISIBLE_OFFLINE_BUTTON_CLASS_NAME_LIST = "btn btn-warning lp-va-panel-button";
        var LP_HIDDEN_BUTTON_CLASS_NAME_LIST = "btn btn-success lp-va-panel-button hide-lp-button";
        var LP_VA_PANEL_EMBEDDED_BUTTON_IDS = [922185332,111]; // NOTE 111 will be replaced by the final ID in PROD account once known.
        // show how to listen to the various events raised by the chat window/ lpTag and button refreshes
        function bindToChatEvents() {
          // make sure the function and objects exist
          if(lpTag && lpTag.events && lpTag.events.bind) {
            
            /* 
              lpUnifiedWindow/state 
                tracks the state of the window itself
                possible values from e.state object:
                init / initialised / waiting / chatting / interactive / resume
             */

            lpTag.events.bind("lpUnifiedWindow", "state",function(e,d){ 
              console.log("--> LivePerson Chat Window Event Detected: state == ",e.state); 
              // if(e.state == "init" || e.state == "initialised" || e.state == "waiting" || e.state == "chatting" || e.state == "interactive") {
              if(e.state == "waiting" || e.state == "resume" || e.state == "interactive") {
                hideVaPanel();
              }

            });

            /* 
              This event tracks the state of the conversation itself
                eventData.state ...
                  ended : chat ended
                  postChat: post chat survey shown
                  applicationEnded : post chat survey submitted     
             */
            lpTag.events.bind("lpUnifiedWindow","conversationInfo",function(eventData,appName){
              console.log('--> LivePerson conversationInfo event : ',eventData.state);

              // if the post chat exit survey has been submitted then auto close the thank you window
              if(eventData.state == "applicationEnded") {
                console.log('--> ',eventData.state,' event fired means post chat survey has been submitted');
                closeThankyouWindow();
                showVaPanel();
              }
               // NOTE: if the chat configuration of the LivePerson Campaign does NOT have an exit survey attached, this event will NOT fire
              // Instead you should trigger this code on the "ended" event instead.
              if(eventData.state == "ended") {
                console.log('--> ',eventData.state,' event fired means post chat survey has been submitted');
                // only use this conditional if you DO NOT have a post chat exit survey configured
                // you would put the same code as above to close the thank you screen
                closeThankyouWindow()
                showVaPanel()
              }

            });

            /* 
              This event fires every time a button is displayed on the page
              You will need to check the e.engagementType value to see what type it is.
              5 = embedded but there may be more than one embedded button on some pages that are NOT va panel related.
              so you will need to look at the e.engagementId property for the event and match it against a list you maintain to know if 
              it is a va panel button or not
              otherwise the engagementName property may give some indication if named correctly on the liveperson side.
            
             */
            lpTag.events.bind("LP_OFFERS", "OFFER_IMPRESSION",function(e,d){
              // check if the type is embedded (5) AND the id matches the array constant of all ids on both accounts DEV/PROD
              if(e.engagementType == "5" && LP_VA_PANEL_EMBEDDED_BUTTON_IDS.indexOf(e.engagementId) > -1) {
                // means embedded button and the unique id of this demo POC embedded button
                // the id will be unique to your account and will differ between DEV and PROD so your code will need to store both values to compare
                lpButtonEngagementId = e.engagementId; // store the value so we can use it later when we need to query the button state later in the process for an accurate value - this is in case the refresh timer has changed the state from online/offline and vice versa
                lpTag.events.trigger("VA_PANEL","EMBEDDED_BUTTON_IMPRESSION",{
                  id:lpButtonEngagementId,
                  cid:e.campaignId,
                  state: e.state
                })
              }
              console.log("--> button impression event ",e.state,e.engagementId,buttonState);
            });

            lpTag.events.bind("VA_PANEL","EMBEDDED_BUTTON_IMPRESSION",function(eventData){
              // the hidden empty HTML button inside the va panel has been loaded...check the state to determine which custom HTML code for our own button should be shown?
                console.log('--> VA_PANEL/EMBEDDED_BUTTON_IMPRESSION ',eventData);
              // as this could happen many times for button on refresh rates, we should always hide both buttons by default and then reshow the relevant one...
              var lpButtons = document.getElementsByClassName('lp-va-panel-button');
                console.log('--> hiding buttons // ',lpButtons);
              for (var i = 0; i < lpButtons.length; i++) {
                var lpButton = lpButtons[i];
                lpButton.className = LP_HIDDEN_BUTTON_CLASS_NAME_LIST; // apply static list of class names to hide the button -- replace with however you choose to do this in the panel
              }

              // this demos how you can control the content of both the online and offline button HTML elements
              // because you will be "fake" clicking the actual LivePerson button hidden on the page with no content, you can display your own responsive buttons and HTML and then control the click function, pass the chat lines and trigger the chat start.
              // this section of code just checks the state of the va panel embedded button from LP and allows to choose which one to show
              // this is because the design agreed allows shows the button at the bottom of the panel - there is NOT an escalation button to reveal it
              if(eventData.state === 1) {
                  console.log('--> button is online, show that custom button html element which you can control in the panel');
                document.getElementById('lp-va-panel-button-online').classList = LP_VISIBLE_ONLINE_BUTTON_CLASS_NAME_LIST;
              } else if (eventData.state === 2) {
                  console.log('--> button is offline, show that custom button html element which you can control in the panel');
                document.getElementById('lp-va-panel-button-offline').classList = LP_VISIBLE_OFFLINE_BUTTON_CLASS_NAME_LIST;
              }
            })

          }

        }

        function triggerChatButtonClick() {
          console.log('--> triggerChatButtonClick ... this function will grab the FAQ conversation lines and feed them to the chat window and then click the hidden button using the rendererStub API');
          // DOCS: https://developers.liveperson.com/trigger-click.html

          if(lpTag && lpTag.taglets && lpTag.taglets.rendererStub){
            // grab FAQ lines...this POC just gets the HTML content from specific class elements...you will use your own API and functions to get this information from the chat in progress.
            var faqLines = document.getElementsByClassName('faq-chat-line');
            var preChatLinesArray = ["Your conversation history so far..."]; // add a message to give context to the chat lines
            for (var f = 0; f < faqLines.length; f++) {
              var faqChatLine = faqLines[f].innerHTML;
              preChatLinesArray.push(faqChatLine);
            }
            preChatLinesArray.push("An agent will be with your shortly to continue the discussion..."); // add a message at the end to tell the customer what will happen next
              console.log('--> preChatLinesArray : ',preChatLinesArray);
            
            // call the click function of the hidden embedded button inside the panel div container and feed in the preChatLines array of content
            var clicked = lpTag.taglets.rendererStub.click(lpButtonEngagementId, {
              preChatLines: preChatLinesArray
            });
          }
        }

        function closeThankyouWindow() {
          var closeBtn = document.querySelector('.lp_close'); // this is the class of the close button

          // if we find it, click to close the thank you screen
          if(closeBtn) {
            closeBtn.click();
            console.log('--> auto closing the thank you screen');
           
          }
        }

        function togglePanel() {
          $('#slideout').toggleClass('on'); 
        }

        // example of how you can query the lpTag and get the latest button state for a unique button engagement id
        // 1 = online
        // 2 = offline
        // 4 = busy
        function checkButtonState() {
          var buttonState = 0;
          if(lpButtonEngagementId) {
            var buttonState = lpTag.taglets.rendererStub.getEngagementState(lpButtonEngagementId).state; // use the number you grabbed earlier when the button was loaded inside the panel
            console.log('--> the button id ',lpButtonEngagementId,' has the state of ',buttonState);
          }
          return buttonState;
        }

        function hideVaPanel() {
          console.log("--> LivePerson Chat window is open ... hiding NEED HELP panel and button...");
          $('#slideout').removeClass('on');
          $('#need-help').hide();
        }
        function showVaPanel() {
          console.log("--> LivePerson Chat session has ended ... bringing back NEED HELP button...");
          $('#need-help').show();
        }


        // click function for the panel tab
        $('.need-help').click(function(){ 
          togglePanel(); // show/hide the panel

          /* 
            At this point the panel is shown and the <div> with the required specific id for LivePerson to deploy the button into does not exist in the DOM
            Therefore, this code mimics the action of the VA panel at some point adding that div with that id to the DOM dynamically
            Once this has been done, you MUST register this with LivePerson as shown below so that our tag can search again for the container div matching the id we provide, and deploy the button content accordingly.

          */
    
          // only do this once! we only need to create the div tag once when first showing the panel
          if(!document.getElementById(LP_VA_PANEL_HIDDEN_EMBEDDED_BUTTON_DIV_CONTAINER_ID)) {
            // if the div id has NOT already been created, then make one and add to the panel in the required position with the required id
            var buttonContainer = document.getElementById('button-container');
            var buttonDiv = document.createElement('div');
            buttonDiv.id = LP_VA_PANEL_HIDDEN_EMBEDDED_BUTTON_DIV_CONTAINER_ID;
            buttonContainer.appendChild(buttonDiv);

            /*************** 
                REQUIRED
            ****************/

            // register button div zone with LivePerson now div exists within the DOM   
            // THIS IS CRUCIAL -it tells our system that the container div for the button now exists and can be attempted to be injected onto the page - in either online/offline state. 
            var sdes = [{
              "type": "pagediv",
              "divId": LP_VA_PANEL_HIDDEN_EMBEDDED_BUTTON_DIV_CONTAINER_ID
            }];
            if(lpTag && lpTag.sdes && lpTag.sdes.send) {
              lpTag.sdes.send(sdes);
            } else if (lpTag && lpTag.sdes.push) {
              lpTag.sdes.push(sdes);
            }
            // ^ The above will tell LP that the div now exists and is ready to receive the content - online/offline/busy etc...
          }

        });

        bindToChatEvents();  // bind to events
      </script>   
    </body>
</html>
